<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="onNestedScroll 像这种一遍滚一遍调的函数，只调一次怎么可以完美地完成我的任务"><meta name=generator content="Hugo 0.81.0"><title>FloatingActionButton的Behavior里面onNestedScroll()只调了一次? &#183; 我说的这句话是谎话</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://jimbray.xyz/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://jimbray.xyz/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=https://jimbray.xyz/css/blackburn.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=https://jimbray.xyz/img/favicon.ico type=image/x-icon><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8790496632299830",enable_page_level_ads:!0})</script><meta name=google-site-verification content="lsfTBJKzPUfwHdKB84_xsa5u_38z1iLbcGOAkxOo03Q"></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://jimbray.xyz/>Jimbray</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/><i class="fa fa-home fa-fw"></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/post/><i class="fa fa-archive fa-fw"></i>Archive</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/tags/><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/note/note><i class="fa fa-sticky-note fa-fw"></i>Notes</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://twitter.com/jimbray16 target=_blank><i class="fa fa-twitter-square fa-fw"></i>Twitter</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/jimbray target=_blank><i class="fa fa-github-square fa-fw"></i>GitHub</a></li></ul></div><div><div class=small-print><small>&copy; 2016. All rights reserved.</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>FloatingActionButton的Behavior里面onNestedScroll()只调了一次?</h1><h2>onNestedScroll 像这种一遍滚一遍调的函数，只调一次怎么可以完美地完成我的任务</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i><time>27 Jun 2018, 20:20</time></div><div><i class="fa fa-tags fa-fw"></i><a class=post-taxonomy-tag href=https://jimbray.xyz/tags/android>Android</a></div></div><p>今天，在重写 FloatingActionButton.Behavior 的时候，遇到了问题，记录一下</p><p>第一个问题，在完成了 behavior 代码之后</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScrollFABBehavior</span> <span style=color:#66d9ef>extends</span> FloatingActionButton<span style=color:#f92672>.</span><span style=color:#a6e22e>Behavior</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>onStartNestedScroll</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> CoordinatorLayout coordinatorLayout<span style=color:#f92672>,</span>
                                       <span style=color:#a6e22e>@NonNull</span> FloatingActionButton child<span style=color:#f92672>,</span>
                                       <span style=color:#a6e22e>@NonNull</span> View directTargetChild<span style=color:#f92672>,</span>
                                       <span style=color:#a6e22e>@NonNull</span> View target<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> axes<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// Ensure we react to vertical scrolling
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> axes <span style=color:#f92672>==</span> ViewCompat<span style=color:#f92672>.</span><span style=color:#a6e22e>SCROLL_AXIS_VERTICAL</span>
                <span style=color:#f92672>||</span> <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onStartNestedScroll</span><span style=color:#f92672>(</span>coordinatorLayout<span style=color:#f92672>,</span> child<span style=color:#f92672>,</span> directTargetChild<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> axes<span style=color:#f92672>);</span>

    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onNestedScroll</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> CoordinatorLayout coordinatorLayout<span style=color:#f92672>,</span>
                               <span style=color:#a6e22e>@NonNull</span> FloatingActionButton child<span style=color:#f92672>,</span>
                               <span style=color:#a6e22e>@NonNull</span> View target<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dxConsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dyConsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dxUnconsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dyUnconsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onNestedScroll</span><span style=color:#f92672>(</span>coordinatorLayout<span style=color:#f92672>,</span> child<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dxConsumed<span style=color:#f92672>,</span> dyConsumed<span style=color:#f92672>,</span> dxUnconsumed<span style=color:#f92672>,</span> dyUnconsumed<span style=color:#f92672>,</span> type<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dyConsumed <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>&amp;&amp;</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBLE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            child<span style=color:#f92672>.</span><span style=color:#a6e22e>hide</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dyConsumed <span style=color:#f92672>&lt;=</span> 0 <span style=color:#f92672>&amp;&amp;</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBLE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            child<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div><p>用在 FAB 上的时候 出现了 异常</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>Could not inflate Behavior subclass com.example.....ScrollFABBehavior
</code></pre></div><p>仔细一看，shit，忘记了 从 xml 加载对应的 构造函数</p><p>加上就解决了</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ScrollFABBehavior</span><span style=color:#f92672>(</span>Context context<span style=color:#f92672>,</span> AttributeSet attrs<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>super</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>接下来是第二个问题</p><p>FAB 的 hide() 没有问题，可以hide 完之后 不show 了。</p><p>跟踪一下发现，onNestedScroll() 只调用了一次</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e>         * Called when a nested scroll in progress has updated and the target has scrolled or
</span><span style=color:#75715e>         * attempted to scroll.
</span><span style=color:#75715e>         *
</span><span style=color:#75715e>         * &lt;p&gt;Any Behavior associated with the direct child of the CoordinatorLayout may elect
</span><span style=color:#75715e>         * to accept the nested scroll as part of {@link #onStartNestedScroll}. Each Behavior
</span><span style=color:#75715e>         * that returned true will receive subsequent nested scroll events for that nested scroll.
</span><span style=color:#75715e>         * &lt;/p&gt;
</span><span style=color:#75715e>         *
</span><span style=color:#75715e>         * &lt;p&gt;&lt;code&gt;onNestedScroll&lt;/code&gt; is called each time the nested scroll is updated by the
</span><span style=color:#75715e>         * nested scrolling child, with both consumed and unconsumed components of the scroll
</span><span style=color:#75715e>         * supplied in pixels. &lt;em&gt;Each Behavior responding to the nested scroll will receive the
</span><span style=color:#75715e>         * same values.&lt;/em&gt;
</span><span style=color:#75715e>         * &lt;/p&gt;
</span><span style=color:#75715e>         *
</span><span style=color:#75715e>         * @param coordinatorLayout the CoordinatorLayout parent of the view this Behavior is
</span><span style=color:#75715e>         *                          associated with
</span><span style=color:#75715e>         * @param child the child view of the CoordinatorLayout this Behavior is associated with
</span><span style=color:#75715e>         * @param target the descendant view of the CoordinatorLayout performing the nested scroll
</span><span style=color:#75715e>         * @param dxConsumed horizontal pixels consumed by the target&#39;s own scrolling operation
</span><span style=color:#75715e>         * @param dyConsumed vertical pixels consumed by the target&#39;s own scrolling operation
</span><span style=color:#75715e>         * @param dxUnconsumed horizontal pixels not consumed by the target&#39;s own scrolling
</span><span style=color:#75715e>         *                     operation, but requested by the user
</span><span style=color:#75715e>         * @param dyUnconsumed vertical pixels not consumed by the target&#39;s own scrolling operation,
</span><span style=color:#75715e>         *                     but requested by the user
</span><span style=color:#75715e>         * @param type the type of input which cause this scroll event
</span><span style=color:#75715e>         *
</span><span style=color:#75715e>         * @see NestedScrollingParent2#onNestedScroll(View, int, int, int, int, int)
</span><span style=color:#75715e>         */</span>
</code></pre></div><p>这好像是在逗我？我也看不懂，大概意思就是 这个函数在 scroll 的时候就会更新</p><p>可是并没有</p><p>解决办法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onNestedScroll</span><span style=color:#f92672>(</span><span style=color:#a6e22e>@NonNull</span> CoordinatorLayout coordinatorLayout<span style=color:#f92672>,</span>
                               <span style=color:#a6e22e>@NonNull</span> FloatingActionButton child<span style=color:#f92672>,</span>
                               <span style=color:#a6e22e>@NonNull</span> View target<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dxConsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dyConsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dxUnconsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> dyUnconsumed<span style=color:#f92672>,</span>
                               <span style=color:#66d9ef>int</span> type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onNestedScroll</span><span style=color:#f92672>(</span>coordinatorLayout<span style=color:#f92672>,</span> child<span style=color:#f92672>,</span> target<span style=color:#f92672>,</span> dxConsumed<span style=color:#f92672>,</span> dyConsumed<span style=color:#f92672>,</span> dxUnconsumed<span style=color:#f92672>,</span> dyUnconsumed<span style=color:#f92672>,</span> type<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dyConsumed <span style=color:#f92672>&gt;</span> 0 <span style=color:#f92672>&amp;&amp;</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>==</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBLE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            child<span style=color:#f92672>.</span><span style=color:#a6e22e>hide</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FloatingActionButton<span style=color:#f92672>.</span><span style=color:#a6e22e>OnVisibilityChangedListener</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                <span style=color:#a6e22e>@Override</span>
                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onShown</span><span style=color:#f92672>(</span>FloatingActionButton fab<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onShown</span><span style=color:#f92672>(</span>fab<span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>

                <span style=color:#a6e22e>@Override</span>
                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onHidden</span><span style=color:#f92672>(</span>FloatingActionButton fab<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>super</span><span style=color:#f92672>.</span><span style=color:#a6e22e>onHidden</span><span style=color:#f92672>(</span>fab<span style=color:#f92672>);</span>
                    fab<span style=color:#f92672>.</span><span style=color:#a6e22e>setVisibility</span><span style=color:#f92672>(</span>View<span style=color:#f92672>.</span><span style=color:#a6e22e>INVISIBLE</span><span style=color:#f92672>);</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>dyConsumed <span style=color:#f92672>&lt;=</span> 0 <span style=color:#f92672>&amp;&amp;</span> child<span style=color:#f92672>.</span><span style=color:#a6e22e>getVisibility</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> View<span style=color:#f92672>.</span><span style=color:#a6e22e>VISIBLE</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            child<span style=color:#f92672>.</span><span style=color:#a6e22e>show</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>跟上面的区别就是 hide 的时候 别把 FAB visibility 变成GONE，而是变成 INVISIBLE</p><p>GONE 与 INVISIBLE 的区别就不说了。</p><p>为什么会发生这种情况呢？</p><p>道听途说：FAB都GONE 掉了，就不跟踪Scroll状态了，所以也就没有 onNestedScroll() 什么事，但是INVISIBLE 就不同了，会很勤奋地做这件事情，虽然看不见。</p><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=https://jimbray.xyz/post/android-n-with-fileuriexposedexception/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=https://jimbray.xyz/post/android-n-with-fileuriexposedexception/>Android N 出现FileUriExposedException的兼容处理</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=https://jimbray.xyz/post/using-flutter-in-china/>Flutter 卡在 package get 的解决办法</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=https://jimbray.xyz/post/using-flutter-in-china/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='jimbray-github-io',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=https://jimbray.xyz/js/ui.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-78813427-1','auto'),ga('send','pageview')</script></body></html>