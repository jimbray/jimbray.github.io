<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="对之前简陋版的升级修改"><meta name=generator content="Hugo 0.81.0"><title>简化markdown写作中的贴图流程（windows基本版） &#183; 我说的这句话是谎话</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://jimbray.xyz/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://jimbray.xyz/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=https://jimbray.xyz/css/blackburn.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=https://jimbray.xyz/img/favicon.ico type=image/x-icon><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8790496632299830",enable_page_level_ads:!0})</script><meta name=google-site-verification content="lsfTBJKzPUfwHdKB84_xsa5u_38z1iLbcGOAkxOo03Q"></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://jimbray.xyz/>Jimbray</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/><i class="fa fa-home fa-fw"></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/post/><i class="fa fa-archive fa-fw"></i>Archive</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/tags/><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/note/note><i class="fa fa-sticky-note fa-fw"></i>Notes</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://twitter.com/jimbray16 target=_blank><i class="fa fa-twitter-square fa-fw"></i>Twitter</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/jimbray target=_blank><i class="fa fa-github-square fa-fw"></i>GitHub</a></li></ul></div><div><div class=small-print><small>&copy; 2016. All rights reserved.</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>简化markdown写作中的贴图流程（windows基本版）</h1><h2>对之前简陋版的升级修改</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i><time>19 Jun 2016, 21:12</time></div><div><i class="fa fa-tags fa-fw"></i><a class=post-taxonomy-tag href=https://jimbray.xyz/tags/python>Python</a></div></div><p>接上一篇文章 <a href=http://jimbray.xyz/2016/06/14/python-to-qiniu/>简化markdown写作中的贴图流程（windows简陋版）</a></p><p>上一篇文章是 做了很久，除了对python不熟，还有懒，所以最终的结果不尽人意，可以说做出来一个半成品。能用，但用起来不爽。
所以，现在完成了基本版，基本版基本可用了</p><p>上次的版本是 获取 全屏截图，这样的话像QQ截图这些功能都用不上了，而且还是显示很多不必要的元素在截图里面，比如说下面这个图啊
<img src=http://driver.365yhb.cn/img_1466342265.26.jpg alt=不必要.jpg>
箭头所指的地方，根本不应该出现在截图里面的，是多余的元素。
废话不多说，开干。
思路跟实现跟上次一点区别都没有
代码也只是修改了一个函数，其他的基本没有变化
主要记录遇到的几个问题</p><h3 id=代码>代码</h3><p>先把代码贴出来，再上问题</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>save_clipboard_image</span>():
    im <span style=color:#f92672>=</span> ImageGrab<span style=color:#f92672>.</span>grabclipboard()
    <span style=color:#66d9ef>if</span> im <span style=color:#f92672>is</span> None:
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Error: No image data in clipboard&#39;</span>)
        <span style=color:#66d9ef>return</span> None

    <span style=color:#66d9ef>if</span> isinstance(im, Image<span style=color:#f92672>.</span>Image):
        <span style=color:#66d9ef>print</span> im<span style=color:#f92672>.</span>format, im<span style=color:#f92672>.</span>size, im<span style=color:#f92672>.</span>mode
        width, height <span style=color:#f92672>=</span> im<span style=color:#f92672>.</span>size
        saved_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;img_&#34;</span> <span style=color:#f92672>+</span> str(time<span style=color:#f92672>.</span>time()) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.jpg&#34;</span>
        <span style=color:#75715e># im.resize((30, 30), Image.ANTIALIAS).load()</span>
        im<span style=color:#f92672>.</span>save(saved_path)

        <span style=color:#66d9ef>print</span> saved_path
        <span style=color:#66d9ef>return</span> saved_path
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>print</span> <span style=color:#e6db74>&#39;the object in clipboard is not a image.&#39;</span>
        <span style=color:#66d9ef>return</span> None
</code></pre></div><p>这个函数是修改的，之前是获取全屏截图，现在修改为获取剪贴板中的图片</p><h4 id=遇到的问题>遇到的问题</h4><h5 id=问题1>问题1</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Unsupported BMP bitfields layout
</code></pre></div><p>这个是 Pillow 的bug，搜索到解决办法：</p><p>作者：青南
链接：<a href=https://zhuanlan.zhihu.com/p/21303461>https://zhuanlan.zhihu.com/p/21303461</a>
来源：知乎</p><p>这个问题从Pillow 2.8.0开始，一直到3.2.0都没有被官方解决。目前有一个间接的解决办法。
请打开Python安装目录下的\Lib\site-packages\PIL\BmpImagePlugin.py文件，将以下代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>if</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED:
    <span style=color:#66d9ef>if</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>32</span> <span style=color:#f92672>and</span> file_info[<span style=color:#e6db74>&#39;rgba_mask&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED[file_info[<span style=color:#e6db74>&#39;bits&#39;</span>]]:
        raw_mode <span style=color:#f92672>=</span> MASK_MODES[(file_info[<span style=color:#e6db74>&#39;bits&#39;</span>], file_info[<span style=color:#e6db74>&#39;rgba_mask&#39;</span>])]
        self<span style=color:#f92672>.</span>mode <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RGBA&#34;</span> <span style=color:#66d9ef>if</span> raw_mode <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;BGRA&#34;</span>,) <span style=color:#66d9ef>else</span> self<span style=color:#f92672>.</span>mode
    <span style=color:#66d9ef>elif</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>in</span> (<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>16</span>) <span style=color:#f92672>and</span> file_info[<span style=color:#e6db74>&#39;rgb_mask&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED[file_info[<span style=color:#e6db74>&#39;bits&#39;</span>]]:
        raw_mode <span style=color:#f92672>=</span> MASK_MODES[(file_info[<span style=color:#e6db74>&#39;bits&#39;</span>], file_info[<span style=color:#e6db74>&#39;rgb_mask&#39;</span>])]
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Unsupported BMP bitfields layout&#34;</span>)
<span style=color:#66d9ef>else</span>:
    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Unsupported BMP bitfields layout&#34;</span>)
</code></pre></div><p>修改为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>if</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED:
    <span style=color:#66d9ef>if</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>32</span> <span style=color:#f92672>and</span> file_info[<span style=color:#e6db74>&#39;rgba_mask&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED[file_info[<span style=color:#e6db74>&#39;bits&#39;</span>]]:
        raw_mode <span style=color:#f92672>=</span> MASK_MODES[(file_info[<span style=color:#e6db74>&#39;bits&#39;</span>], file_info[<span style=color:#e6db74>&#39;rgba_mask&#39;</span>])]
        self<span style=color:#f92672>.</span>mode <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;RGBA&#34;</span> <span style=color:#66d9ef>if</span> raw_mode <span style=color:#f92672>in</span> (<span style=color:#e6db74>&#34;BGRA&#34;</span>,) <span style=color:#66d9ef>else</span> self<span style=color:#f92672>.</span>mode
    <span style=color:#66d9ef>elif</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>in</span> (<span style=color:#ae81ff>24</span>, <span style=color:#ae81ff>16</span>) <span style=color:#f92672>and</span> file_info[<span style=color:#e6db74>&#39;rgb_mask&#39;</span>] <span style=color:#f92672>in</span> SUPPORTED[file_info[<span style=color:#e6db74>&#39;bits&#39;</span>]]:
        raw_mode <span style=color:#f92672>=</span> MASK_MODES[(file_info[<span style=color:#e6db74>&#39;bits&#39;</span>], file_info[<span style=color:#e6db74>&#39;rgb_mask&#39;</span>])]
    <span style=color:#e6db74>&#39;&#39;&#39;新增内容开始&#39;&#39;&#39;</span>
    <span style=color:#66d9ef>elif</span> file_info[<span style=color:#e6db74>&#39;bits&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>32</span> <span style=color:#f92672>and</span> file_info[<span style=color:#e6db74>&#39;rgb_mask&#39;</span>] <span style=color:#f92672>==</span> (<span style=color:#ae81ff>0xff0000</span>, <span style=color:#ae81ff>0xff00</span>, <span style=color:#ae81ff>0xff</span>):
        <span style=color:#66d9ef>pass</span>
    <span style=color:#e6db74>&#39;&#39;&#39;新增内容结束&#39;&#39;&#39;</span>
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Unsupported BMP bitfields layout&#34;</span>)
<span style=color:#66d9ef>else</span>:
    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#34;Unsupported BMP bitfields layout&#34;</span>)
</code></pre></div><p>就能解决本问题。</p><h5 id=问题2>问题2</h5><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>IOError: image file is truncated <span style=color:#f92672>(</span><span style=color:#ae81ff>1044</span> bytes not processed<span style=color:#f92672>)</span>
</code></pre></div><p>搜索到解决办法 <a href=http://www.cnblogs.com/hongfei/p/4436767.html>Python：IOError: image file is truncated 的解决办法</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> ImageFile
ImageFile<span style=color:#f92672>.</span>LOAD_TRUNCATED_IMAGES <span style=color:#f92672>=</span> True
</code></pre></div><p>问题解决。在 ahk脚本中修改以下 新python文件的路径就可以愉快地玩耍了</p><pre><code class=language-ahk data-lang=ahk>^!v::
run,%comspec% /c python D:\python\clipboard_to_qiniu.py
</code></pre><p>reload 以下 ahk 脚本，使用方法跟之前一模一样，不过现在支持像QQ这类切图软件了。</p><h3 id=改进>改进</h3><p>每次截图之后，就会发现 python文件所在文件夹就会多一张图片，都是已经上传到七牛的了，留下来没有什么用处，还浪费我空间。
那就再加一个逻辑吧：上传到七牛后删除本地的图片</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>deleteLocalImage</span>(path):
    <span style=color:#66d9ef>if</span>(os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>isfile(path)):<span style=color:#75715e>#文件存在</span>
        os<span style=color:#f92672>.</span>remove(path)
</code></pre></div><p>主函数也修改以下</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    saved_path <span style=color:#f92672>=</span> save_clipboard_image()
    <span style=color:#66d9ef>if</span> saved_path <span style=color:#f92672>==</span> None:
        <span style=color:#66d9ef>pass</span>
    <span style=color:#66d9ef>else</span>:
        q <span style=color:#f92672>=</span> Qiniu(AK, SK)
        q<span style=color:#f92672>.</span>upload_file(bucket_name, saved_path, saved_path)
        deleteLocalImage(saved_path)
</code></pre></div><p>搞定收工。
这次用起来比较普通了。
<img src=http://driver.365yhb.cn/%E6%99%AE%E6%99%AE%E9%80%9A%E9%80%9A.jpg alt=普普通通.jpg></p><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=https://jimbray.xyz/post/python-to-qiniu/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=https://jimbray.xyz/post/python-to-qiniu/>简化markdown写作中的贴图流程（windows简陋版）</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=https://jimbray.xyz/post/manual_install_lnmp/>Ubuntu/Debian手动安装完成lnmp部署wordpress</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=https://jimbray.xyz/post/manual_install_lnmp/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='jimbray-github-io',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=https://jimbray.xyz/js/ui.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-78813427-1','auto'),ga('send','pageview')</script></body></html>