<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在现有AS项目中加入 OpenCV 的c++ SDK"><meta name=generator content="Hugo 0.81.0"><title>在现有AS项目中新增OpenCV c++库的支持 &#183; 我说的这句话是谎话</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css><!--[if lte IE 8]><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css><!--<![endif]--><!--[if lte IE 8]><link rel=stylesheet href=https://jimbray.xyz/css/side-menu-old-ie.css><![endif]--><!--[if gt IE 8]><!--><link rel=stylesheet href=https://jimbray.xyz/css/side-menu.css><!--<![endif]--><link rel=stylesheet href=https://jimbray.xyz/css/blackburn.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link href="https://fonts.googleapis.com/css?family=Raleway" rel=stylesheet type=text/css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><link rel="shortcut icon" href=https://jimbray.xyz/img/favicon.ico type=image/x-icon><script async src=//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-8790496632299830",enable_page_level_ads:!0})</script><meta name=google-site-verification content="lsfTBJKzPUfwHdKB84_xsa5u_38z1iLbcGOAkxOo03Q"></head><body><div id=layout><a href=#menu id=menuLink class=menu-link><span></span></a><div id=menu><a class="pure-menu-heading brand" href=https://jimbray.xyz/>Jimbray</a><div class=pure-menu><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/><i class="fa fa-home fa-fw"></i>Home</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/post/><i class="fa fa-archive fa-fw"></i>Archive</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/tags/><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://jimbray.xyz/note/note><i class="fa fa-sticky-note fa-fw"></i>Notes</a></li></ul></div><div class="pure-menu social"><ul class=pure-menu-list><li class=pure-menu-item><a class=pure-menu-link href=https://twitter.com/jimbray16 target=_blank><i class="fa fa-twitter-square fa-fw"></i>Twitter</a></li><li class=pure-menu-item><a class=pure-menu-link href=https://github.com/jimbray target=_blank><i class="fa fa-github-square fa-fw"></i>GitHub</a></li></ul></div><div><div class=small-print><small>&copy; 2016. All rights reserved.</small></div><div class=small-print><small>Built with&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a></small>
<small>Theme&nbsp;<a href=https://github.com/yoshiharuyamashita/blackburn target=_blank>Blackburn</a></small></div></div></div><div id=main><div class=header><h1>在现有AS项目中新增OpenCV c++库的支持</h1><h2>在现有AS项目中加入 OpenCV 的c++ SDK</h2></div><div class=content><div class=post-meta><div><i class="fa fa-calendar fa-fw"></i><time>22 Mar 2020, 20:16</time></div><div><i class="fa fa-tags fa-fw"></i><a class=post-taxonomy-tag href=https://jimbray.xyz/tags/android>Android</a></div></div><p>本文在 AS 3.4.1 版本下实现。</p><p>使用的是 4.1.1 版本的 opencv android sdk</p><p>现在最新版本下载地址在： <a href=https://opencv.org/releases/>https://opencv.org/releases/</a></p><h3 id=步骤>步骤</h3><ol><li><p>AS 切换到 project 目录下</p></li><li><p>进入目录 app&ndash;src，右键 src，新建 Directory.命名为 cpp</p></li><li><p>右键 cpp文件夹，新建 cpp文件，命名为 cv-lib.cpp</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>//
</span><span style=color:#75715e>// Created by jimbray on 2020/3/17.
</span><span style=color:#75715e>//
</span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;jni.h&gt;</span><span style=color:#75715e>
</span></code></pre></div><p>先导入 jni 头文件</p></li><li><p>右键 cpp文件夹，新建 CMakeLists.txt 文件</p></li><li><p>CMakeLists.txt 文件填入内容</p><pre><code># For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html
   
# Sets the minimum version of CMake required to build the native library.
   
cmake_minimum_required(VERSION 3.4.1)
   
   
# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.
   
# 定义自己写的库
add_library( # Sets the name of the library.
        cv-lib
   
        # Sets the library as a shared library.
        SHARED
   
        # Provides a relative path to your source file(s).
        cv-lib.cpp)
   
   
# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.
   
# 如果需要其他NDK原生库的话，可自行在此处添加
find_library( # Sets the name of the path variable.
        log-lib
   
        # Specifies the name of the NDK library that
        # you want CMake to locate.
        log)
   
   
target_link_libraries( # Specifies the target library.
        cv-lib
   
        # Links the target library to the log library
        # included in the NDK.
        ${log-lib})
</code></pre><p>CMake配置学习不在本文范围之内</p></li><li><p>进入 app 对应的 build.gradle，做以下操作</p><p>​ 在defaultconfig 块下新增</p><ul><li><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>externalNativeBuild <span style=color:#f92672>{</span>
            cmake <span style=color:#f92672>{</span>
                cppFlags <span style=color:#e6db74>&#34;-std=c++14 -fexceptions -frtti&#34;</span>
                arguments <span style=color:#e6db74>&#34;-DANDROID_ARM_NEON=TRUE&#34;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;-DANDROID_STL=c++_shared&#39;</span>
                <span style=color:#75715e>// abi过滤
</span><span style=color:#75715e></span>                abiFilters <span style=color:#e6db74>&#39;armeabi-v7a&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;arm64-v8a&#39;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
        <span style=color:#75715e>// abi过滤
</span><span style=color:#75715e></span>        ndk <span style=color:#f92672>{</span>
            abiFilters <span style=color:#e6db74>&#39;armeabi-v7a&#39;</span><span style=color:#f92672>,</span><span style=color:#e6db74>&#39;arm64-v8a&#39;</span>
        <span style=color:#f92672>}</span>
</code></pre></div></li><li><p>在android块下新增</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#75715e>// c/c++源码位置
</span><span style=color:#75715e></span>    sourceSets <span style=color:#f92672>{</span>
        main <span style=color:#f92672>{</span>
            jni<span style=color:#f92672>.</span><span style=color:#a6e22e>srcDirs</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;src/main/cpp&#39;</span><span style=color:#f92672>]</span>
            jniLibs<span style=color:#f92672>.</span><span style=color:#a6e22e>srcDirs</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#39;src/main/jniLibs/libs&#39;</span><span style=color:#f92672>]</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
    externalNativeBuild <span style=color:#f92672>{</span>
        cmake <span style=color:#f92672>{</span>
            path <span style=color:#e6db74>&#34;src/main/cpp/CMakeLists.txt&#34;</span>
            version <span style=color:#e6db74>&#34;3.10.2&#34;</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
</code></pre></div><p>注意相应的路径，不要照抄。</p></li></ul></li><li><p>导入 open 的库与代码</p><ul><li><p>导入 动态so库</p><p><img src=https://i.loli.net/2020/03/23/szwejkP46ZXEyqo.png alt=image-20200323143023734></p></li></ul><p>复制 libs 在指定的目录，这个目录（jniLibs/libs）是在 build.gradle 配置好的，需要对应。</p><p>复制 OpenCV的jni文件夹到 cpp 目录，文件夹路径在 sdk/native/jni，直接复制 include文件夹内</p><p><img src=https://i.loli.net/2020/03/23/9uF5C8LEidIaAGw.png alt=image-20200323143106734></p><p>此时已经完成了 c++ 的接入配置，以下为验证手段。</p></li></ol><h3 id=验证>验证</h3><ol><li><p>在src-main-java 文件夹内新建 java 文件，命名为 JNITools.java</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>package</span> xyz.jimbray.demo<span style=color:#f92672>;</span>
   
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JNITools</span> <span style=color:#f92672>{</span>
   
    <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>loadLibrary</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;cv-lib&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
   
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>native</span> String <span style=color:#a6e22e>getHelloString</span><span style=color:#f92672>();</span>
   
<span style=color:#f92672>}</span>
   
</code></pre></div></li><li><p>如果已经配置成功，AS现在会在 getHelloString 函数处提示错误，AS这个版本已经支持直接跳转到 cpp 文件新建对应函数。</p></li><li><p>但是我试的时候，出现直接跳转到一个 自动新建的 test-cpp-lib.c 文件，无视我自建的 cpp 文件，还报错。</p></li><li><p>我把 c 文件的内容直接复制到 cpp 文件，删除 c 文件，就可以了。</p></li><li><p>运行一下，调用成功。</p></li></ol><div class="prev-next-post pure-g"><div class=pure-u-1-24 style=text-align:left><a href=https://jimbray.xyz/post/remote-service-by-aidl/><i class="fa fa-chevron-left"></i></a></div><div class=pure-u-10-24><nav class=prev><a href=https://jimbray.xyz/post/remote-service-by-aidl/>使用AIDL实现多进程Service的流程（使用XMPP Service为例）</a></nav></div><div class=pure-u-2-24>&nbsp;</div><div class=pure-u-10-24><nav class=next><a href=https://jimbray.xyz/post/android-array-to-image/>Android像素二维数组转图像的实现</a></nav></div><div class=pure-u-1-24 style=text-align:right><a href=https://jimbray.xyz/post/android-array-to-image/><i class="fa fa-chevron-right"></i></a></div></div><div id=disqus_thread></div><script type=text/javascript>(function(){var a,b;if(window.location.hostname=="localhost")return;a=document.createElement('script'),a.type='text/javascript',a.async=!0,b='jimbray-github-io',a.src='//'+b+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><script src=https://jimbray.xyz/js/ui.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-78813427-1','auto'),ga('send','pageview')</script></body></html>