<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="才第二个完整的自定义View, 路还很长">
  <meta name="generator" content="Hugo 0.25.1" />

  <title>我的第二个自定义View &middot; JIMBRAY</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="http://jimbray.xyz/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="http://jimbray.xyz/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="http://jimbray.xyz/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="http://jimbray.xyz/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="http://jimbray.xyz/">Jimbray</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://jimbray.xyz/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://jimbray.xyz/post/"><i class='fa fa-archive fa-fw'></i>Archive</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://jimbray.xyz/tags/"><i class='fa fa-tags fa-fw'></i>Tags</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="http://jimbray.xyz/note/note"><i class='fa fa-sticky-note fa-fw'></i>Notes</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>



  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  
  <ins class="adsbygoogle"
            style="display:inline-block;width:300px;height:600px"
	         data-ad-client="ca-pub-2960593853032576"
	       data-ad-slot="1610352031"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


</div>


  <div id="main">


<div class="header">
  <h1>我的第二个自定义View</h1>
  <h2>才第二个完整的自定义View, 路还很长</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>14 Jul 2016, 15:19</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="http://jimbray.xyz/tags/android">Android</a>
    
  </div>
  
  

</div>

  <p>自古以来，第一个总是抢走了所有的聚光灯。
怎么办，我是第二个。</p>

<p>据说有一个国际惯例，要真相
那就来吧
<img src="http://7xv11f.com1.z0.glb.clouddn.com/my-second-custom-view.gif" alt="真相" /></p>

<p>看到了吗。
下边那个圆环就是我们第二个主角啦。
上面那个是 传说中的第一个。
没办法，第二个不管再怎么好看也比不上 号称第一的那位。
这，应该是一个诅咒。</p>

<pre><code>
/**
 * Created by Jimbray  .
 * on 2016/7/13
 * Email: jimbray16@gmail.com
 * Description: 这是我第二个自定义View。
 * 第一个永远是被人铭记的，可是第二个呢
 * 问你一个问题：世界上最高的山峰是？
 * 答：当然是珠穆朗玛峰啦！
 * 那第二高的呢？
 * 答：当然是乔戈里峰啦！
 * -_- 你不按套路出牌啊，套路里你是不知道的！
 */
public class MySecondProgressbar extends View {

    private Context mContext;

    // 准备好画圆环的矩形区域
    private RectF mRectF = new RectF(0, 0, 0, 0);
    // 准备好画文字的矩形区域
    private RectF mTextRrectF = new RectF(0, 0, 0, 0);

    // 握好画笔啊，有三个频段，还有一个文字
    private Paint mHeavyProgressPaint, mModerateProgressPaint, mLightProgressPaint, mTextPaint;

    // 默认值设置
    private final float default_height  = dp2px(45);
    private final float default_width   = dp2px(45);
    private final int default_heavy_color = Color.rgb(255, 54, 102);
    private final int default_moderate_color = Color.rgb(255, 128, 97);
    private final int default_light_color = Color.rgb(8, 176, 242);
    private final int default_text_color = Color.rgb(0, 0, 0);
    private final float default_text_size = sp2px(14);
    private final float default_heavy_progress_width = dp2px(12);
    private final float defaule_moderate_progress_width = dp2px(12);
    private final float default_light_progress_width = dp2px(12);

    //三个频段，三种颜色啊，还有一个是字体颜色
    private int mHeavyColor, mModerateColor, mLightColor, mTextColor;
    //画的东西宽高，还是给个默认值好了
    private float mViewHeight, mViewWidth;
    //我们画的是圆环，要多粗有多粗，定海神针，啊不，定海神环
    private float mHeavyProgressWidth, mModerateProgressWidth, mLightProgresswidth;

    private boolean mIfDrawText; //是不是要画一下中间的文字呢。还是 写
    private String mCurrentDrawText; //画的文字你得告诉我吧
    private float mTextSize; //字别太大，会撑着
    private int mTextBaseLine; //这个 我是抄的

    private float mCircleOffset = dp2px(15); //人与人之间的距离不要太近，还是要有一定的安全距离。不然亲上了怎么办。

    private float mCurrentProgress; //这第二个自定义View还是一个progressbar
    private float mCurHeavy, mCurModerate, mCurLight; //三个频段，三个单词是突然想到的，不知道什么意思

    public enum MySecondProgressTextVisibility {// 跟第一个自定义View最大的不同就是 ：名字
        Visible, Invisible
    }

    public MySecondProgressbar(Context context) {
        super(context);
        init(context, null, 0);
    }

    public MySecondProgressbar(Context context, AttributeSet attrs) {
        super(context, attrs);
        init(context, attrs, 0);
    }

    public MySecondProgressbar(Context context, AttributeSet attrs, int defStyleAttr) {
        super(context, attrs, defStyleAttr);
        init(context, attrs, defStyleAttr);
    }

    /**
     *
     * 不想解释
     * @param context
     * @param attrs
     * @param defStyleAttr
     */
    private void init(Context context, AttributeSet attrs, int defStyleAttr) {
        this.mContext = context;

        mHeavyColor = default_heavy_color;
        mModerateColor = default_moderate_color;
        mLightColor = default_light_color;
        mTextColor = default_text_color;

        mViewWidth = default_width;
        mViewHeight = default_height;

        mTextSize = default_text_size;

        mHeavyProgressWidth = default_heavy_progress_width;
        mModerateProgressWidth = defaule_moderate_progress_width;
        mLightProgresswidth = default_light_progress_width;

        mIfDrawText = true;

        initPainters();
    }

    /**
     * 上颜料
     */
    private void initPainters() {
        mHeavyProgressPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
        mHeavyProgressPaint.setColor(mHeavyColor);
        mHeavyProgressPaint.setStyle(Paint.Style.STROKE);
        mHeavyProgressPaint.setStrokeWidth(mHeavyProgressWidth);

        mModerateProgressPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
        mModerateProgressPaint.setColor(mModerateColor);
        mModerateProgressPaint.setStyle(Paint.Style.STROKE);
        mModerateProgressPaint.setStrokeWidth(mModerateProgressWidth);

        mLightProgressPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
        mLightProgressPaint.setColor(mLightColor);
        mLightProgressPaint.setStyle(Paint.Style.STROKE);
        mLightProgressPaint.setStrokeWidth(mLightProgresswidth);

        mTextPaint = new Paint(Paint.ANTI_ALIAS_FLAG);
        mTextPaint.setColor(mTextColor);
        mTextPaint.setTextAlign(Paint.Align.CENTER);
        mTextPaint.setTextSize(mTextSize);
    }

    /**
     * 最小宽度 由你定
     * 不定我来给个最小值吧
     * @return
     */
    @Override
    protected int getSuggestedMinimumWidth() {
        return (int) mViewWidth;
    }

    /**
     * 跟宽度一个意思
     * @return
     */
    @Override
    protected int getSuggestedMinimumHeight() {
        return (int) mViewHeight;
    }

    /**
     * @param canvas
     * 咱先分析一下
     * 要画什么
     * 我要画一个圆环
     * 圆环里面有三个频段的显示（不同颜色）
     * 这三个频段呢，分别代表三个数值的占比关系
     * 中间放个文字吧，不然太空
     * 好像就这样
     */
    @Override
    protected void onDraw(Canvas canvas) {
        if(mIfDrawText) {
            calWithText();
        } else {
            calWithoutText();
        }

        //上面已经把我们要画的区域圈出来了
        //可以施展拳脚，不对，是画笔了

        float heavy_sweep_angle = mCurHeavy / mCurrentProgress; //算一下占比
        heavy_sweep_angle = heavy_sweep_angle * 360; //占比最终还是要转换成角度的，0.5的话就是180度
        if(mCurHeavy != 0) {
            //从上面12点钟的位置开始，就是270啦，我不喜欢负数，扫过多大的角度呢
            canvas.drawArc(mRectF, 270, heavy_sweep_angle, false, mHeavyProgressPaint); //试试把false改为true玩一玩，顺便把paint 的stroke属性去掉。有惊喜哦！
        }

        //跟上面的意思差不多啦。
        float moderate_sweep_angle = mCurModerate / mCurrentProgress;
        moderate_sweep_angle = moderate_sweep_angle * 360;
        if(mCurModerate != 0) {
            canvas.drawArc(mRectF, 270 + heavy_sweep_angle, moderate_sweep_angle, false, mModerateProgressPaint);
        }

        //还是一样的。
        float light_sweep_angle = mCurLight / mCurrentProgress;
        light_sweep_angle = light_sweep_angle * 360;
        if(mCurLight != 0) {
            canvas.drawArc(mRectF, 270 + heavy_sweep_angle + moderate_sweep_angle, light_sweep_angle, false, mLightProgressPaint);
        }
        //上面已经把圆环都画完了

        //画个原点，我是来确定我写的字是不是在中间，不能我说在中间就是在中间是吧。如果它不是在中间，我把它说成在中间，然后被你发现它不在中间，那我不是很尴尬。
//        canvas.drawOval(getWidth() /2 - 1 , getHeight() / 2 - 1, getWidth() / 2 + 1, getHeight() / 2 + 1, mHeavyProgressPaint); //画个圆点，看看文字是不是居中的

        if(mIfDrawText) { //准备书法

//            canvas.drawRect(mTextRrectF, mLightProgressPaint); //画个矩形 把text 框起来 ,参照物
            //第一种
            //这个是不对的做法，我以为是写在了中间
//            canvas.drawText(mCurrentDrawText, getWidth() / 2.0f, getHeight() / 2.0f + (mTextPaint.descent() + mTextPaint.ascent()), mTextPaint);

            //第二种
            // 后来我知道我错了，所以我就将错就错，再错一次
//            float text_width = mTextPaint.measureText(mCurrentDrawText);
//            canvas.drawText(mCurrentDrawText, mTextRrectF.left + text_width/2.0f, mTextRrectF.bottom, mTextPaint);

            //第三种
            //又来了!快看我找到的解决方案：[等灯等灯](http://blog.csdn.net/hursing/article/details/18703599)
            canvas.drawText(mCurrentDrawText, mTextRrectF.centerX(), mTextBaseLine, mTextPaint);
        }

    }

    /**
     * 精华1
     * 这里不写字
     */
    private void calWithoutText() {
        mRectF.left = getPaddingLeft() + mCircleOffset;
        mRectF.top = getPaddingTop() + mCircleOffset;
        mRectF.right = getWidth() - getPaddingRight() - mCircleOffset;
        mRectF.bottom = getHeight() - getPaddingBottom() - mCircleOffset;

        //就完啦？
        //你说的对呀
        //我就确定个区域，咋滴啦
    }

    /**
     * 精华2
     */
    private void calWithText() {
        mRectF.left = getPaddingLeft() + mCircleOffset;
        mRectF.top = getPaddingTop() + mCircleOffset;
        mRectF.right = getWidth() - getPaddingRight() - mCircleOffset;
        mRectF.bottom = getHeight() - getPaddingBottom() - mCircleOffset;

        if(!TextUtils.isEmpty(mCurrentDrawText)) {
            float text_width = mTextPaint.measureText(mCurrentDrawText);
            mTextRrectF.left = getWidth() / 2.0f - text_width / 2.0f;
            mTextRrectF.top = getHeight() / 2.0f - mTextSize / 2.0f;
            mTextRrectF.right = getWidth() / 2.0f + text_width / 2.0f;
            mTextRrectF.bottom = getHeight() / 2.0f + mTextSize / 2.0f;

            //这里是计算 文字居中的解决方案 具体请访问我搜到的 [这是我找到的](http://blog.csdn.net/hursing/article/details/18703599)
            Paint.FontMetricsInt fontMetrics = mTextPaint.getFontMetricsInt();
            mTextBaseLine = (int) ((mTextRrectF.bottom + mTextRrectF.top - fontMetrics.bottom - fontMetrics.top) / 2);
        } else {
            mIfDrawText = false;
        }

        //这里还是确定个区域的问题
        //只不过多了文字的区域
    }

    /**
     * 这个套路还是可以再深一点
     * 不过我是新司机
     * 不会换档
     * @param widthMeasureSpec
     * @param heightMeasureSpec
     */
    @Override
    protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        setMeasuredDimension(measure(widthMeasureSpec, true), measure(heightMeasureSpec, false));
    }

    /**
     * 测量 view 的 宽高信息
     * @param measureSpec
     * @param isWidth
     * @return
     */
    private int measure(int measureSpec, boolean isWidth) {
        int result;
        int mode = MeasureSpec.getMode(measureSpec);
        int size = MeasureSpec.getSize(measureSpec);
        int padding = isWidth ? getPaddingLeft() + getPaddingRight() : getPaddingTop() + getPaddingBottom();
        if (mode == MeasureSpec.EXACTLY) {
            result = size;
        } else {
            result = isWidth ? getSuggestedMinimumWidth() : getSuggestedMinimumHeight();
            result += padding;
            if (mode == MeasureSpec.AT_MOST) {
                if (isWidth) {
                    result = Math.max(result, size);
                } else {
                    result = Math.min(result, size);
                }
            }
        }
        return result;
    }


    public float dp2px(float dp) {
        final float scale = getResources().getDisplayMetrics().density;
        return dp * scale + 0.5f;
    }

    public float sp2px(float sp) {
        final float scale = getResources().getDisplayMetrics().scaledDensity;
        return sp * scale;
    }

    private void setProgressTextVisibility(MySecondProgressTextVisibility visibility) {
        mIfDrawText = visibility == MySecondProgressTextVisibility.Visible;
    }

    public void setProgress(float heavy, float moderate, float light) {
        this.mCurrentProgress = heavy + moderate + light;
        this.mCurHeavy = heavy;
        this.mCurModerate = moderate;
        this.mCurLight = light;
        invalidate();
    }

    /**
     * 加个动画
     * 就会变成屌屌的
     * 我知道我为什么选progressbar来做第一个自定义View了
     * 因为
     * 其他的我也不会啊
     * @param heavy
     * @param moderate
     * @param light
     */
    public void animProgress(float heavy, float moderate, float light) {
        this.mCurrentProgress = heavy + moderate + light;

        ValueAnimator heavy_animator = ValueAnimator.ofFloat(0, heavy);
        heavy_animator.setInterpolator(new LinearInterpolator());
        heavy_animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {
            @Override
            public void onAnimationUpdate(ValueAnimator animation) {
                mCurHeavy = (float) animation.getAnimatedValue();
                postInvalidate();
            }
        });

        ValueAnimator moderate_animator = ValueAnimator.ofFloat(0, moderate);
        moderate_animator.setInterpolator(new LinearInterpolator());
        moderate_animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {
            @Override
            public void onAnimationUpdate(ValueAnimator animation) {
                mCurModerate = (float) animation.getAnimatedValue();
                postInvalidate();
            }
        });


        ValueAnimator light_animator = ValueAnimator.ofFloat(0, light);
        light_animator.setInterpolator(new LinearInterpolator());
        light_animator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener() {
            @Override
            public void onAnimationUpdate(ValueAnimator animation) {
                mCurLight = (float) animation.getAnimatedValue();
                postInvalidate();
            }
        });

        AnimatorSet animSet = new AnimatorSet();
        animSet.setDuration(1000);
        animSet.playTogether(light_animator, moderate_animator, heavy_animator);
        animSet.start();
    }

    public void setProgressText(String text) {
        this.mCurrentDrawText = text;
        invalidate();
    }
}

</code></pre>

<p>第二个也写完了。
这个我没有抄别人的啊。
我抄的是第一个自定义View 的。
敲完了。</p>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="http://jimbray.xyz/post/my-first-custom-view/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="http://jimbray.xyz/post/my-first-custom-view/">我的第一个自定义View</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="http://jimbray.xyz/post/my-third-customview/">我的第三个自定义View</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="http://jimbray.xyz/post/my-third-customview/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'jimbray-github-io';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="http://jimbray.xyz/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78813427-1', 'auto');
  ga('send', 'pageview');

</script>





</body>
</html>

